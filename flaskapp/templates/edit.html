<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Krake Crag</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .object {
            cursor: pointer;
            position: absolute;
            border: none;
        }
        .wall-image {
            display: none;
            max-width: 100%;
            position: relative;
        }
        .active {
            display: block;
        }
        .image-container {
            position: relative;
        }
    </style>
</head>
<body>
    <div class="content-wrapper">
        <h1 class="center-text">Velkommen til Krakes klatrevæg</h1>
        <div id="entry-name" class="center-text">Nyt problem</div>
        <p class="center-text">To cirkler ved startgreb</p>
        <div>
            <button class="button wall-toggle" data-wall="1">Venstre væg</button>
            <button class="button wall-toggle" data-wall="2">Højre væg</button>
        </div>

        <div class="image-container">
            <img id="wall1" class="wall-image" data-wall="1" src="{{ url_for('static', filename='wallv.jpg') }}">
            <div class="object-layer" data-wall="1"></div>
            <img id="wall2" class="wall-image" data-wall="2" src="{{ url_for('static', filename='wallh.jpg') }}">
            <div class="object-layer" data-wall="2"></div>
        </div>

        <button id="clearSelection" class="button">Fjern selektion</button>
        <label for="entryName">Grad, navn og beskrivelse af problem:</label>
        <input type="text" id="entryName">
        <button id="saveEntry" class="button">Gem problem</button>

        <h2>Problemer:</h2>
        <ul id="entriesList"></ul>

        <script>
            let selectedObjects = { wall1: [], wall2: [] };

            function loadObjects(wall) {
                $.getJSON(`{{ url_for('static', filename='objects') }}${wall}.json`, function(data) {
                    const layer = $(`.object-layer[data-wall="${wall}"]`);
                    data.forEach((obj, index) => {
                        const div = $('<div class="object"></div>')
                            .data('object', obj)
                            .data('index', index)
                            .attr('data-wall', wall);
                        layer.append(div);
                    });
                    adjustPositions(wall);
                    attachHandlers(wall);
                });
            }

            function adjustPositions(wall) {
                const img = $(`#wall${wall}`);
                const width = img.width();
                const height = img.height();
                $(`.object[data-wall="${wall}"]`).each(function() {
                    const obj = $(this).data('object');
                    $(this).css({
                        top: (obj.top_percent / 100 * height) + 'px',
                        left: (obj.left_percent / 100 * width) + 'px',
                        width: (obj.width_percent / 100 * width) + 'px',
                        height: (obj.height_percent / 100 * height) + 'px'
                    });
                });
            }

            function attachHandlers(wall) {
                $(`.object[data-wall="${wall}"]`).on('click', function () {
                    const index = $(this).data('index');
                    const key = `wall${wall}`;
                    if ($(this).hasClass('selected')) {
                        $(this).removeClass('selected');
                        selectedObjects[key] = selectedObjects[key].filter(i => i !== index);
                    } else {
                        $(this).addClass('selected');
                        selectedObjects[key].push(index);
                    }
                });
            }

            $(document).on('click', '.wall-toggle', function () {
                const wall = $(this).data('wall');
                $('.wall-image').removeClass('active');
                $(`#wall${wall}`).addClass('active');
                $('.object-layer').hide();
                $(`.object-layer[data-wall="${wall}"]`).show();
            });

            $('#clearSelection').on('click', function () {
                $('.object').removeClass('selected');
                selectedObjects = { wall1: [], wall2: [] };
                $('#entry-name').text('Nyt problem');
                $('#entryName').val('');
            });

	$('#saveEntry').on('click', function () {
	    const name = $('#entryName').val();
	    const editingId = $(this).data('editing');

	    const entryRegex = /^[345]\+?, |^[678][ABC]\+?, |^Projekt, /;
	    if (!entryRegex.test(name)) {
		alert("Tekst skal starte med sværhedsgrad eller med 'Projekt'");
		return;
	    }

	    if (editingId) {
		// update existing entry
		$.ajax({
		    url: `/update_entry/${editingId}`,
		    type: 'POST',
		    contentType: 'application/json',
		    data: JSON.stringify({ name: name }),
		    success: function (response) {
			if (response.status === 'success') {
			    alert('Problem opdateret');
			    $('#saveEntry').removeData('editing').text('Gem problem');
			    loadEntries();
			}
		    }
		});
		$('.object').removeClass('selected');
                selectedObjects = { wall1: [], wall2: [] };
                $('#entry-name').text('Nyt problem');
                $('#entryName').val('');
	    } else {
		// save new entry
		$.ajax({
		    url: '/save_entry',
		    type: 'POST',
		    contentType: 'application/json',
		    data: JSON.stringify({
			name: name,
			selected_objects: selectedObjects
		    }),
		    success: function (response) {
			if (response.status === 'success') {
			    alert('Problem gemt i databasen');
			    loadEntries();
			    $('#entry-name').text('Nyt problem');
			    $('#entryName').val('');
			    $('.object').removeClass('selected');
			    selectedObjects = { wall1: [], wall2: [] };
			}
		    }
		});
	    }
	});

            function loadEntries() {
                $.get('/get_entries', function (entries) {
                    $('#entriesList').empty();
                    entries.sort((a, b) => a[1].localeCompare(b[1]));
                    entries.forEach(entry => {
                        $('#entriesList').append(`<li data-id="${entry[0]}"><span class="entry-text">${entry[1]}</span><div class="entry-buttons"><button class="editEntry">Rediger</button><button class="deleteEntry">Slet</button></div></li>`);
                    });
                });
            }

            $(document).ready(function () {
                loadObjects(1);
                loadObjects(2);
                $('#wall1').addClass('active');
                $(`.object-layer[data-wall="1"]`).show();
                loadEntries();
            });

	// Handle clicking on entry text to view/highlight
	$('#entriesList').on('click', '.entry-text', function () {
	    const entryId = $(this).closest('li').data('id');
	    $.get(`/entry/${entryId}`, function(entry) {
		const selections = entry[2];
		$('.object').removeClass('selected');

		const wallsUsed = [];
		if (selections.wall1.length > 0) {
		    selections.wall1.forEach(index => {
			$(`.object[data-wall="1"]`).eq(index).addClass('selected');
		    });
		    wallsUsed.push(1);
		}
		if (selections.wall2.length > 0) {
		    selections.wall2.forEach(index => {
			$(`.object[data-wall="2"]`).eq(index).addClass('selected');
		    });
		    wallsUsed.push(2);
		}

		if (wallsUsed.length === 1) {
		    $('.wall-image').removeClass('active');
		    $(`#wall${wallsUsed[0]}`).addClass('active');
		    $('.object-layer').hide();
		    $(`.object-layer[data-wall="${wallsUsed[0]}"]`).show();
		} else {
		    $('.wall-image').removeClass('active');
		    $('#wall1').addClass('active');
		    $('.object-layer').hide();
		    $(`.object-layer[data-wall="1"]`).show();
		}

		$('#entry-name').text(entry[1]);
		$('html, body').animate({
		    scrollTop: $('h1').offset().top + $('h1').outerHeight()
		}, 500);
	    });
	});

	// Handle edit
	$('#entriesList').on('click', '.editEntry', function () {
	    const entryId = $(this).closest('li').data('id');
	    $.get(`/entry/${entryId}`, function(entry) {
		$('#entry-name').text('Rediger problem');
		$('#entryName').val(entry[1]);

		$('.object').removeClass('selected');
		selectedObjects = { wall1: [], wall2: [] };

		if (entry[2].wall1.length > 0) {
		    entry[2].wall1.forEach(index => {
			$(`.object[data-wall="1"]`).eq(index).addClass('selected');
		    });
		    selectedObjects.wall1 = entry[2].wall1;
		}
		if (entry[2].wall2.length > 0) {
		    entry[2].wall2.forEach(index => {
			$(`.object[data-wall="2"]`).eq(index).addClass('selected');
		    });
		    selectedObjects.wall2 = entry[2].wall2;
		}

		$('#saveEntry')
		    .data('editing', entryId)
		    .text('Opdater problem');
	    });
	});

	// Handle delete
	$('#entriesList').on('click', '.deleteEntry', function () {
	    const entryId = $(this).closest('li').data('id');
	    if (confirm('Er du sikker på du vil slette dette problem?')) {
		$.post(`/delete_entry/${entryId}`, function (response) {
		    if (response.status === 'success') {
			loadEntries();
		    }
		});
	    }
	});

        </script>
    </div>
</body>
</html>
